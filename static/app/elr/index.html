<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ELR Fare Estimate</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&family=Source+Code+Pro:wght@500&family=JetBrains+Mono:wght@700&family=Poppins:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#f6f7fb;
      color:#111;
    }

    .wrap{ max-width:620px; margin:44px auto; padding:0 16px; }

    .card{
      background:#fff;
      border:1px solid #e7e9f3;
      border-radius:16px;
      box-shadow:0 10px 26px rgba(20,20,50,.06);
      padding:20px;
    }

h1{
  margin:0 0 18px;
  font-size:20px;
  text-align:center;
  font-family:"Poppins","Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

    .helper{
      font-size:13px;
      color:#555;
      margin-bottom:8px;
    }

    /* Mapbox fields */
    .mapbox-fields{ display:flex; flex-direction:column; gap:10px; margin-bottom:12px; }
    .mapbox-fields label{ display:block; font-size:12px; font-weight:700; color:#333; margin-bottom:4px; }

    .mapbox-row-full{ width:100%; min-width:0; }
    .mapbox-suggestions{ position:relative; }

    .mapbox-field{
      width:100%;
      max-width:100%;
      border:1px solid #cfd5e6;
      border-radius:10px;
      padding:14px 12px;
      font-size:15px;
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#fff;
    }

    .mapbox-chip-inline{
      position:absolute;
      left:10px;
      top:50%;
      transform:translateY(-50%);
      display:none;
      pointer-events:auto;
    }
    .mapbox-chip-inline .selChip{ margin:0; background:#f7f8ff; }
    .mapbox-field.has-inline-chip{ padding-left:144px; }

    .mapbox-suggestions ul{
      list-style:none;
      margin:6px 0 0;
      padding:6px;
      border:1px solid #e0e5f3;
      border-radius:10px;
      background:#fff;
      box-shadow:0 10px 24px rgba(20,20,50,.08);
    }
    .mapbox-suggestions button{
      width:100%; text-align:left; border:none; background:none; padding:8px 8px; border-radius:8px; font-size:14px; cursor:pointer;
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .mapbox-suggestions button:hover{ background:#f2f5ff; }

    .schedule-control{ position:relative; width:100%; min-width:0; }
    .schedule-input{ padding-left:60px; width:100%; max-width:100%; min-width:0; display:block; }
    .swap-inline{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid #cfd5e6;
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(20,20,50,.08);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
      z-index:2;
    }
    .swap-inline:disabled{ opacity:0.4; cursor:default; box-shadow:none; }
    .swap-inline:not(:disabled):hover{ transform:translateY(-50%) translateY(-2px); box-shadow:0 8px 18px rgba(20,20,50,.12); background:#f6f8ff; }

    /* Trip card */
.trip-card{
      position:relative;
      margin-top:16px;
      padding:18px;
      background:#5F78C9;
      border-radius:14px;
      border:1px solid #4d62aa;
      text-align:center;
    }
    .metric .k{ font-size:13px;color:#FFFFFF; margin-bottom:6px; }
    .metric .v{ font-size:38px;font-weight:800;color:#FFFFFF; font-family:"JetBrains Mono","Source Code Pro",monospace; transition:filter .2s ease, opacity .2s ease; }
    .metric .v.loading{ filter:blur(3px); opacity:0.5; }
    .metric .note{
      margin-top:8px;
      font-size:15px;
      color:#FFFFFF;
      line-height:1.4;
      min-height:14px;
    }
    .copy-btn{
      border:1px solid #4d62aa;
      background:#fff;
      color:#2e3f70;
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      font-weight:700;
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(20,20,50,.12);
      display:none;
      align-items:center;
      gap:6px;
      transition:transform .15s ease, box-shadow .15s ease, opacity .15s ease;
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      position:relative;
      overflow:hidden;
    }
    .copy-btn:hover{ transform:translateY(-1px); box-shadow:0 9px 18px rgba(20,20,50,.16); }
    .copy-btn:active{ transform:translateY(0); }
    .copy-btn.copied{
      background:#e7f0ff;
      color:#1b2f63;
      box-shadow:0 10px 20px rgba(20,20,50,.18);
      transform:translateY(-1px);
    }
    .copy-btn.sending{
      transform:translateY(0) scale(0.99);
      box-shadow:0 10px 20px rgba(20,20,50,.18);
    }
    .copy-btn:disabled{
      opacity:0;
      cursor:default;
      box-shadow:none;
      transform:none;
    }
    .wa-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      flex-shrink:0;
      margin-right:4px;
      color:#25D366;
      font-size:18px;
    }
    @keyframes copyFlash{
      0%{ left:-60%; opacity:0; }
      10%{ opacity:0.8; }
      50%{ left:100%; opacity:0.8; }
      100%{ left:100%; opacity:0; }
    }
    .copy-btn.copied::after{
      animation: copyFlash 1.2s ease;
      opacity:1;
    }
    .copy-btn.visible::after{
      animation: copyFlash 1.8s ease infinite;
      opacity:1;
    }
    .copy-btn::after{
      content:"";
      position:absolute;
      left:-60%;
      top:0;
      width:40%;
      height:100%;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 50%, rgba(255,255,255,0) 100%);
      transform:skewX(-20deg);
      opacity:0;
      pointer-events:none;
    }

    /* Selected chip */
    .selChip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid #dfe4f2;
      color:#111;
      font-weight:400;
      font-size:14px;
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      white-space:nowrap;
      user-select:none;
    }
    .selChip button{ background:none; border:none; font-size:16px; cursor:pointer; line-height:1; padding:0 2px; color:#111; }

    /* Footer */
    .footer-bar{ margin-top:20px; display:flex; justify-content:space-between; align-items:center; gap:12px; font-size:11px; color:#777; }
    #timestamp{ font-family:"Source Code Pro",Consolas,"SFMono-Regular",Menlo,monospace; letter-spacing:0px; font-size:10px; }
    .footer-bar a{ color:#555; text-decoration:none; font-weight:600; }
    .signature{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:11px; color:#333; }
    .sig-dot{ display:inline-flex; align-items:center; gap:4px; color:#444; font-weight:400; }
    .sig-dot .dot{ width:8px; height:8px; border-radius:50%; background:linear-gradient(135deg,#ff9f43,#ff6b6b); box-shadow:0 0 0 2px rgba(255,107,107,0.18); }
    .sig-dot .sig-name{ font-weight:700; color:#333; }
    .sec{ display:inline; transition: opacity .15s ease; }
    .sec.off{ opacity:0.15; }
  </style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1>ELR Fare Estimate</h1>
<div class="helper"></div>

<div class="trip-card" id="tripCard">
  <div class="metric">
    <div class="v" id="price">$0</div>
    <div class="note" id="priceNote"><span id="distanceValue">--</span> <span id="distanceSuffix">miles driving</span></div>
  </div>
  <div style="height:6px;"></div>
  <button id="copyTrip" class="copy-btn" type="button" aria-label="Post in ELR group">
    <span aria-hidden="true" class="wa-icon"><i class="fa-brands fa-whatsapp"></i></span>
    Post in ELR Group
  </button>
</div>

<div style="height:12px;"></div>

<div class="mapbox-fields">
  <div class="mapbox-row-full">
    <label for="toLocation">Pickup</label>
    <div class="mapbox-suggestions">
      <input
        id="toLocation"
        class="mapbox-field"
        type="text"
        placeholder="Start typing a location"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      >
      <div id="toChipWrapper" class="mapbox-chip-inline">
        <span id="toChip" class="selChip" style="display:none;">
          <span id="toChipText"></span>
          <button id="toChipClear" type="button">√ó</button>
        </span>
      </div>
      <div id="toResults"></div>
    </div>
  </div>
  <div class="mapbox-row-full">
    <label for="fromLocation">Drop Off</label>
    <div class="mapbox-suggestions">
      <input
        id="fromLocation"
        class="mapbox-field"
        type="text"
        placeholder="Start typing a location"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      >
      <div id="fromChipWrapper" class="mapbox-chip-inline">
        <span id="fromChip" class="selChip" style="display:none;">
          <span id="fromChipText"></span>
          <button id="fromChipClear" type="button">√ó</button>
        </span>
      </div>
      <div id="fromResults"></div>
    </div>
  </div>
  <div class="mapbox-row-full" style="display:flex;align-items:flex-end;gap:12px;">
    <div style="flex:1;">
      <label for="scheduleInput">Pickup Time</label>
      <div class="schedule-control">
        <button id="swapBtn" class="swap-inline" type="button" aria-label="Swap From and To" disabled>‚áÖ</button>
        <input
          id="scheduleInput"
          class="schedule-input mapbox-field"
          type="datetime-local"
        >
      </div>
    </div>
  </div>
</div>

<div class="footer-bar">
  <div id="timestamp"></div>
  <div class="signature">
    <span class="sig-dot">
      <span class="dot"></span>
      built by <a class="sig-name" href="https://www.shiva.dev" target="_blank" style="text-decoration:underline;">Shiva</a>
    </span>
  </div>
</div>

</div>
</div>

<script>
const MAPBOX_ACCESS_TOKEN=window.MAPBOX_ACCESS_TOKEN||"pk.eyJ1IjoibGF6eWRldmVsb3BlciIsImEiOiJjbWtiOTA4b2cwMWZiM2VweGdhMmE1Y3h4In0.YkjBVRuEZVG8_Naj49z8sA";
const MAPBOX_SESSION_TOKEN=(crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2));
const MAPBOX_COUNTRY="US";
const MAPBOX_BBOX="-75.563587,38.788657,-73.88506,41.357423"; // New Jersey bounds
const SUGGEST_LIMIT=5;
const MAX_MILES=3999;
const MIN_QUERY_LENGTH=4;
const DEBOUNCE_MS=350;
const CACHE_TTL_MS=24*60*60*1000; // 24h
const RECENT_LIMIT=6;

const timestampEl=document.getElementById("timestamp");
const distanceValue=document.getElementById("distanceValue");
const distanceSuffix=document.getElementById("distanceSuffix");
const distanceNote=null; // distance note removed from UI; keep null for guards
const price=document.getElementById("price");
const priceNote=document.getElementById("priceNote");
const fromLocation=document.getElementById("fromLocation");
const fromResults=document.getElementById("fromResults");
const fromChipWrapper=document.getElementById("fromChipWrapper");
const fromChip=document.getElementById("fromChip");
const fromChipText=document.getElementById("fromChipText");
const fromChipClear=document.getElementById("fromChipClear");
const toLocation=document.getElementById("toLocation");
const toResults=document.getElementById("toResults");
const toChipWrapper=document.getElementById("toChipWrapper");
const toChip=document.getElementById("toChip");
const toChipText=document.getElementById("toChipText");
const toChipClear=document.getElementById("toChipClear");
const swapBtn=document.getElementById("swapBtn");
const scheduleInput=document.getElementById("scheduleInput");
const copyTrip=document.getElementById("copyTrip");

let mapboxAbortController=null;
let distanceAbortController=null;
const selectedPlaces={from:null,to:null};
const mapboxFields={
  from:{key:"from",input:fromLocation,results:fromResults,chipWrapper:fromChipWrapper,chip:fromChip,chipText:fromChipText,chipClear:fromChipClear},
  to:{key:"to",input:toLocation,results:toResults,chipWrapper:toChipWrapper,chip:toChip,chipText:toChipText,chipClear:toChipClear}
};
const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// Timestamp
function pad2(n){ return String(n).padStart(2,"0"); }
function formatStamp(d){
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const MMM=months[d.getMonth()];
  const DD=pad2(d.getDate());
  let hh=d.getHours();
  const ampm = hh>=12 ? "pm" : "am";
  hh = hh%12; if(hh===0) hh=12;
  const mm=pad2(d.getMinutes());
  return `${MMM} ${DD}, ${hh}<span class="sec" id="blinkColon">:</span>${mm}${ampm}`;
}
function tick(){
  const now=new Date();
  timestampEl.innerHTML = formatStamp(now);
  const colonEl=document.getElementById("blinkColon");
  if(colonEl){
    if(now.getSeconds()%2===0) colonEl.classList.add("off");
    else colonEl.classList.remove("off");
  }
}
tick();
setInterval(tick, 1000);

// Utils
function roundToFiveMinutes(d){ const ms=1000*60*5; return new Date(Math.round(d.getTime()/ms)*ms); }
function addHours(d,h){ return new Date(d.getTime()+h*60*60*1000); }
function toLocalInput(d){
  const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function formatFriendlyWhen(d){
  if(!(d instanceof Date) || Number.isNaN(d.getTime())) return "now";
  const now=new Date();
  const startOfDay=(dt)=>new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
  const today=startOfDay(now).getTime();
  const target=startOfDay(d).getTime();
  const diffDays=Math.round((target - today)/(1000*60*60*24));
  const timeStr=d.toLocaleTimeString(undefined,{hour:"numeric",minute:"2-digit"});
  if(diffDays===0) return `Today at ${timeStr}`;
  if(diffDays===1) return `Tomorrow at ${timeStr}`;
  const weekday=d.toLocaleDateString(undefined,{weekday:"long"});
  return `${weekday} at ${timeStr}`;
}

function normalizeLocationText(text){
  if(!text) return text;
  let t=text.replace(/,\s*(United States|USA|United States of America)\.?$/i,"");
  t=t.replace(/\bNew Jersey\b/gi,"NJ");
  return t.trim();
}

function abbreviateLocation(text){
  if(!text) return text;
  const map={
    "Avenue":"Ave",
    "Street":"St",
    "Road":"Rd",
    "Drive":"Dr",
    "Lane":"Ln",
    "Court":"Ct",
    "Boulevard":"Blvd",
    "Parkway":"Pkwy",
    "Highway":"Hwy",
    "West":"W",
    "East":"E",
    "North":"N",
    "South":"S"
  };
  const pattern=new RegExp(`\\b(${Object.keys(map).join("|")})\\b`,"gi");
  return text.replace(pattern,(m)=>map[m.charAt(0).toUpperCase()+m.slice(1).toLowerCase()]||m);
}

function formatSuggestionLabel(item, selectionValue, headline){
  const addr = item.full_address?.split(",")[0]?.trim() || item.name || item.context?.address?.name || headline;
  const city=item.context?.place?.name;
  const state=normalizeLocationText(item.context?.region?.abbr || item.context?.region?.name || "");
  const tail=[city,state].filter(Boolean).join(", ");
  const labelParts=[];
  if(addr) labelParts.push(addr);
  if(tail) labelParts.push(tail);
  const label=abbreviateLocation(labelParts.join(" ").trim());
  return label || selectionValue || headline || "Unknown";
}

function calcFare(miles){
  if(miles<1)return 5;
  if(miles<=10)return Math.round(5+miles);
  if(miles<=15)return Math.round(5+miles*1.1);
  if(miles<=20)return Math.round(5+miles*1.2);
  return Math.round(5+miles*1.3);
}
function fareFormulaText(miles){
  if(miles<=10)return"Fare = $5 + miles (rounded)";
  if(miles<=15)return"Fare = $5 + (miles √ó 1.1), rounded";
  if(miles<=20)return"Fare = $5 + (miles √ó 1.2), rounded";
  return"Fare = $5 + (miles √ó 1.3), rounded";
}

// Local cache helpers (24h TTL)
function getCache(key){
  try{
    const raw=localStorage.getItem(key);
    if(!raw) return null;
    const {ts,data}=JSON.parse(raw);
    if(!ts||!data) return null;
    if(Date.now()-ts>CACHE_TTL_MS){ localStorage.removeItem(key); return null; }
    return data;
  }catch{ return null; }
}
function setCache(key,data){
  try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(),data})); }catch{}
}

// Recents helpers
function loadRecents(){
  try{
    const raw=localStorage.getItem("recentPlaces");
    if(!raw) return [];
    const arr=JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    const now=Date.now();
    const fresh=arr.filter(item=>item?.ts && now-item.ts<CACHE_TTL_MS && item.label && item.coords);
    return fresh.slice(0,RECENT_LIMIT);
  }catch{ return []; }
}
function saveRecent(entry){
  try{
    const recents=loadRecents();
    const filtered=recents.filter(r=>!(r.mapboxId && entry.mapboxId && r.mapboxId===entry.mapboxId) && r.label!==entry.label);
    filtered.unshift({...entry,ts:Date.now()});
    const trimmed=filtered.slice(0,RECENT_LIMIT);
    localStorage.setItem("recentPlaces", JSON.stringify(trimmed));
  }catch{}
}

// Debounce helper
function debounce(fn, delay){
  let t;
  return function(...args){
    clearTimeout(t);
    t=setTimeout(()=>fn.apply(this,args), delay);
  };
}

// Count-up animation for miles text
let milesAnimFrame=null;
function animateMilesValue(targetMiles){
  if(milesAnimFrame) cancelAnimationFrame(milesAnimFrame);
  return new Promise(resolve=>{
    const startVal=parseFloat(distanceValue.dataset.value||"0")||0;
    const toVal=targetMiles;
    const duration=420;
    const start=performance.now();
    function step(now){
      const t=Math.min(1,(now-start)/duration);
      const eased=1-Math.pow(1-t,3);
      const val=startVal+(toVal-startVal)*eased;
      distanceValue.textContent=val.toFixed(1);
      distanceValue.dataset.value=val;
      if(t<1){
        milesAnimFrame=requestAnimationFrame(step);
      } else {
        resolve();
      }
    }
    milesAnimFrame=requestAnimationFrame(step);
  });
}

function showChip(field,text){
  field.chipText.textContent=text;
  field.chip.style.display="inline-flex";
  field.chipWrapper.style.display="block";
  field.input.classList.add("has-inline-chip");
  field.input.dataset.selected=text;
  field.input.value="";
  field.input.placeholder="";
}
function hideChip(field){
  field.chip.style.display="none";
  field.chipText.textContent="";
  field.chipWrapper.style.display="none";
  field.input.classList.remove("has-inline-chip");
  delete field.input.dataset.selected;
  clearSelectedPlace(field.key);
}

function clearSelectedPlace(key){
  selectedPlaces[key]=null;
  updateDistanceUI();
  updateSwapState();
}
function setSelectedPlace(key,data){
  selectedPlaces[key]=data;
  if(data?.coords && data?.label){
    saveRecent({label:data.label,mapboxId:data.mapboxId||null,coords:data.coords});
  }
  updateDistanceUI();
  maybeComputeDistance();
  updateSwapState();
}

function updateDistanceUI(opts={}){
  if(opts.error){
    distanceValue.textContent="--";
    delete distanceValue.dataset.value;
    distanceSuffix.textContent=opts.error;
    if(distanceNote) distanceNote.textContent=opts.error;
    updatePrice({error:opts.error});
    return;
  }
  if(opts.loading){
    distanceValue.textContent="...";
    delete distanceValue.dataset.value;
    distanceSuffix.textContent="Calculating driving distance...";
    if(distanceNote) distanceNote.textContent="Calculating driving distance...";
    updatePrice({loading:true});
    return;
  }
  if(typeof opts.miles==="number"){
    distanceSuffix.textContent="miles driving";
    if(distanceNote) distanceNote.textContent="";
    animateMilesValue(opts.miles).then(()=>updatePrice({miles:opts.miles}));
    return;
  }
  if(selectedPlaces.from && selectedPlaces.to){
    distanceValue.textContent="...";
    delete distanceValue.dataset.value;
    distanceSuffix.textContent="Calculating driving distance...";
    if(distanceNote) distanceNote.textContent="Calculating driving distance...";
    updatePrice({loading:true});
    return;
  }
  distanceValue.textContent="--";
  delete distanceValue.dataset.value;
  distanceSuffix.textContent="miles driving";
  if(distanceNote) distanceNote.textContent="";
  updatePrice();
}

function updateSwapState(){
  const ready=Boolean(selectedPlaces.from && selectedPlaces.to);
  swapBtn.disabled=!ready;
}

function updatePrice(opts={}){
  if(opts.error){
    price.textContent="$0";
    distanceValue.textContent="--";
    distanceSuffix.textContent=opts.error;
    price.classList.remove("loading");
    if(copyTrip){ copyTrip.disabled=true; copyTrip.style.opacity="0"; copyTrip.style.pointerEvents="none"; copyTrip.style.display="none"; }
    return;
  }
  if(opts.loading){
    price.classList.add("loading");
    distanceValue.textContent="...";
    distanceSuffix.textContent="Waiting for distance to estimate fare.";
    if(copyTrip){ copyTrip.disabled=true; copyTrip.style.opacity="0"; copyTrip.style.pointerEvents="none"; copyTrip.style.display="none"; }
    return;
  }
  if(typeof opts.miles==="number"){
    const fare=calcFare(opts.miles);
    price.textContent=`$${fare}`;
    distanceSuffix.textContent="miles driving";
    price.classList.remove("loading");
    if(copyTrip){
      copyTrip.style.display="inline-flex";
      requestAnimationFrame(()=>{
        copyTrip.disabled=false;
        copyTrip.style.opacity="1";
        copyTrip.style.pointerEvents="auto";
        copyTrip.style.transform="translateY(0)";
        copyTrip.classList.add("visible");
      });
    }
    return;
  }
  price.textContent="$0";
  distanceValue.textContent="--";
  distanceSuffix.textContent="miles driving";
  price.classList.remove("loading");
   if(copyTrip){ copyTrip.disabled=true; copyTrip.style.opacity="0"; copyTrip.style.pointerEvents="none"; copyTrip.style.display="none"; }
}

function isNewJerseySuggestion(item){
  const regionAbbr=item?.context?.region?.abbr||"";
  const regionName=item?.context?.region?.name||"";
  return /(^|\b)NJ(\b|$)/i.test(regionAbbr) || /New Jersey/i.test(regionName);
}

async function fetchMapboxSuggestions(q){
  if(!MAPBOX_ACCESS_TOKEN) return;
  const cacheKey=`suggest:${q.toLowerCase()}`;
  const cached=getCache(cacheKey);
  if(cached) return Promise.resolve(cached);
  const url=new URL("https://api.mapbox.com/search/searchbox/v1/suggest");
  url.searchParams.set("q",q);
  url.searchParams.set("language","en");
  url.searchParams.set("limit",String(SUGGEST_LIMIT));
  url.searchParams.set("types","poi,address,place");
  url.searchParams.set("access_token",MAPBOX_ACCESS_TOKEN);
  url.searchParams.set("session_token",MAPBOX_SESSION_TOKEN);
  url.searchParams.set("country",MAPBOX_COUNTRY);
  url.searchParams.set("bbox",MAPBOX_BBOX);
  if(mapboxAbortController) mapboxAbortController.abort();
  mapboxAbortController=new AbortController();
  const res=await fetch(url.toString(),{signal:mapboxAbortController.signal});
  if(!res.ok) throw new Error("Mapbox suggest failed");
  const data=await res.json();
  setCache(cacheKey,data);
  return data;
}

async function fetchPlaceDetails(mapboxId){
  if(!mapboxId) return null;
  const cacheKey=`retrieve:${mapboxId}`;
  const cached=getCache(cacheKey);
  if(cached) return Promise.resolve(cached);
  const url=new URL(`https://api.mapbox.com/search/searchbox/v1/retrieve/${encodeURIComponent(mapboxId)}`);
  url.searchParams.set("session_token",MAPBOX_SESSION_TOKEN);
  url.searchParams.set("access_token",MAPBOX_ACCESS_TOKEN);
  const res=await fetch(url.toString());
  if(!res.ok) throw new Error("Mapbox retrieve failed");
  const data=await res.json();
  const feature=data?.features?.[0];
  const coords=feature?.geometry?.coordinates;
  if(!coords || coords.length<2) return null;
  const payload={coords:{lon:coords[0],lat:coords[1]}};
  setCache(cacheKey,payload);
  return payload;
}

function metersToMiles(m){ return m/1609.344; }
async function fetchDrivingDistance(fromCoords,toCoords,{signal}={}){
  if(!fromCoords || !toCoords) throw new Error("Missing coords");
  const coordsStr=`${fromCoords.lon},${fromCoords.lat};${toCoords.lon},${toCoords.lat}`;
  const url=new URL(`https://api.mapbox.com/directions/v5/mapbox/driving/${coordsStr}`);
  url.searchParams.set("access_token",MAPBOX_ACCESS_TOKEN);
  url.searchParams.set("geometries","geojson");
  url.searchParams.set("overview","false");
  const res=await fetch(url.toString(),{signal});
  if(!res.ok) throw new Error("Directions failed");
  const data=await res.json();
  const distanceMeters=data?.routes?.[0]?.distance;
  if(typeof distanceMeters!=="number") throw new Error("No distance");
  return metersToMiles(distanceMeters);
}

function maybeComputeDistance(){
  const from=selectedPlaces.from;
  const to=selectedPlaces.to;
  if(!from || !to){ updateDistanceUI(); return; }
  if(!from.coords || !to.coords){
    updateDistanceUI({error:"Missing coordinates for one of the locations."});
    return;
  }
  updateDistanceUI({loading:true});
  if(distanceAbortController) distanceAbortController.abort();
  distanceAbortController=new AbortController();
  fetchDrivingDistance(from.coords,to.coords,{signal:distanceAbortController.signal})
    .then(miles=>updateDistanceUI({miles}))
    .catch(err=>{ if(err.name!=="AbortError") updateDistanceUI({error:"Could not fetch driving distance. Try again."}); });
}

function renderResults(field,suggestions){
  if(!suggestions || !suggestions.length){ clearResults(field); return; }
  const filtered = suggestions.filter(isNewJerseySuggestion);
  if(!filtered.length){
    field.results.innerHTML="<ul><li style=\"padding:8px 8px;color:#444;font-size:14px;\">No New Jersey matches</li></ul>";
    return;
  }
  const ul=document.createElement("ul");
  filtered.forEach(item=>{
    const btn=document.createElement("button");
    const headline=item.name || item.place_formatted || item.full_address || item.context?.place?.name || "Unknown";
    const contextParts=[item.context?.address?.name,item.context?.street?.name,item.context?.place?.name,item.context?.region?.name,item.context?.postcode?.name,item.context?.country?.name].filter(Boolean);
    const rawSelection=item.full_address || item.place_formatted || (headline && contextParts.length ? `${headline}, ${contextParts.join(", ")}` : (headline || contextParts.join(", ")));
    const selectionValue=normalizeLocationText(rawSelection);
    const label=formatSuggestionLabel(item, selectionValue, headline);
    btn.innerHTML=`<span aria-hidden="true" style="margin-right:8px;">üìç</span>${label}`;
    btn.type="button";
    btn.addEventListener("click",()=>{
      const val=selectionValue || headline;
      const displayLabel=abbreviateLocation(val);
      showChip(field,displayLabel);
      clearResults(field);
      field.input.focus();
      const coordsFromSuggest=item?.coordinates;
      const hasCoords=coordsFromSuggest && typeof coordsFromSuggest.longitude==="number" && typeof coordsFromSuggest.latitude==="number";
      if(hasCoords){
        setSelectedPlace(field.key,{
          label:displayLabel,
          mapboxId:item.mapbox_id,
          coords:{lon:coordsFromSuggest.longitude,lat:coordsFromSuggest.latitude}
        });
      } else {
        fetchPlaceDetails(item.mapbox_id)
          .then(details=>{
            if(details?.coords){ setSelectedPlace(field.key,{label:displayLabel,mapboxId:item.mapbox_id,coords:details.coords}); }
            else { hideChip(field); updateDistanceUI({error:"Could not retrieve location details."}); }
          })
          .catch(err=>{ if(err.name!=="AbortError"){ hideChip(field); updateDistanceUI({error:"Could not retrieve location details."}); }});
      }
    });
    const li=document.createElement("li");
    li.appendChild(btn);
    ul.appendChild(li);
  });
  field.results.innerHTML="";
  field.results.appendChild(ul);
}

function clearResults(field){ field.results.innerHTML=""; }

function renderRecents(field){
  const recents=loadRecents();
  if(!recents.length){ clearResults(field); return; }
  const ul=document.createElement("ul");
  recents.forEach(item=>{
    const btn=document.createElement("button");
    btn.innerHTML=`<span aria-hidden="true" style="margin-right:8px;">‚è±</span>${item.label}`;
    btn.type="button";
    btn.addEventListener("click",()=>{
      showChip(field,item.label);
      clearResults(field);
      setSelectedPlace(field.key,{label:item.label,mapboxId:item.mapboxId||null,coords:item.coords});
      field.input.focus();
    });
    const li=document.createElement("li");
    li.appendChild(btn);
    ul.appendChild(li);
  });
  field.results.innerHTML="";
  field.results.appendChild(ul);
}

function handleInput(field){
  const q=field.input.value.trim();
  if(!q){ renderRecents(field); return; }
  if(q.length<MIN_QUERY_LENGTH){ clearResults(field); return; }
  hideChip(field);
  fetchMapboxSuggestions(q)
    .then(data=>renderResults(field,data?.suggestions||[]))
    .catch(()=>{});
}

Object.values(mapboxFields).forEach(field=>{
  const debounced=debounce(()=>handleInput(field),DEBOUNCE_MS);
  field.input.addEventListener("input",debounced);
  field.input.addEventListener("focus",()=>{ if(!field.input.value.trim()) renderRecents(field); });
  field.chipClear.addEventListener("click",()=>{
    field.input.value="";
    hideChip(field);
    clearResults(field);
    field.input.placeholder="Start typing a location";
    field.input.focus();
  });
});

document.addEventListener("click",e=>{
  const fields=[fromLocation,toLocation,fromResults,toResults,fromChip,toChip];
  if(fields.some(el=>el && el.contains(e.target))) return;
  [fromResults,toResults].forEach(el=>el.innerHTML="");
});

swapBtn.addEventListener("click",()=>{
  if(swapBtn.disabled) return;
  const temp=selectedPlaces.from;
  selectedPlaces.from=selectedPlaces.to;
  selectedPlaces.to=temp;
  if(selectedPlaces.from){ showChip(mapboxFields.from, selectedPlaces.from.label); }
  if(selectedPlaces.to){ showChip(mapboxFields.to, selectedPlaces.to.label); }
  updateSwapState();
  maybeComputeDistance();
});

// Schedule default
scheduleInput.step="300";
scheduleInput.value=toLocalInput(roundToFiveMinutes(addHours(new Date(),1)));

// Copy price + miles
if(copyTrip){
  copyTrip.addEventListener("click",()=>{
    if(copyTrip.disabled) return;
    const pickup=selectedPlaces.to?.label || "Not set";
    const dropoff=selectedPlaces.from?.label || "Not set";
    const milesText=distanceValue.textContent.trim() ? `${distanceValue.textContent.trim()} miles` : "Miles not set";
    let whenText="now";
    if(scheduleInput.value){
      const d=new Date(scheduleInput.value);
      if(!Number.isNaN(d.getTime())){
        whenText=formatFriendlyWhen(d);
      }
    }
    const priceText=price.textContent.trim()||"$0";
    const line1=`*Looking for 1 way ride ${whenText}*`;
    const line2=`From: ${pickup}`;
    const line3=`To: ${dropoff}`;
    const line4=`Willing to pay ${priceText} for ${milesText} 1 way ride as`;
    const line5=`estimated by our app https://shiva.dev/app/elr/`;
    const payload=[line1,line2,line3,"",line4,line5].join("\n");
    const originalLabel=copyTrip.textContent;
    copyTrip.classList.add("sending");

    // Open WhatsApp share so user can choose a chat/group after a short animation beat
    const encodedMsg=encodeURIComponent(payload);
    const waDeep=`whatsapp://send?text=${encodedMsg}`;
    const waWeb=`https://wa.me/?text=${encodedMsg}`;
    const targetUrl=isMobile?waDeep:waWeb;
    setTimeout(()=>{
      window.location.href=targetUrl;
      setTimeout(()=>{
        copyTrip.classList.remove("sending");
      },700);
    },200);
  });
}

</script>

</body>
</html>
